pipeline {
    agent any
    environment {
        GOOGLE_CREDENTIALS = credentials('jenkins-service-gcp')
    }
    stages {
        stage('Setting Up') {
            steps {
                sh '''
                gcloud version
                gcloud auth activate-service-account --key-file=$GOOGLE_CREDENTIALS
                terraform --version  
                '''
            }
        }
    stage('Deploy Infrastructure'){
        steps {
            sh '''
            terraform init
            terraform apply -auto-approve
            '''
            }
        }
    }
    stage('Build And Push Image'){
        environment { 
                REGION="australia-southeast1"
                PROJECT_ID="streaming-flights-brisbane"
                REPOSITORY_NAME="brisbane-airport-docker"
            }
        steps{
            sh '''
            ./ci/build_and_push_image.sh    
            '''
        }
    }
}